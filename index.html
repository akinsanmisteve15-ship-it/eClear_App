<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
    <title>eClear | Premium Super App</title>
    
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: https:; connect-src 'self' ws://127.0.0.1:* http://127.0.0.1:* https://ipapi.co; font-src 'self' data: https:; img-src 'self' data: https: blob:;">
    
    <link rel="stylesheet" href="designs/tokens.css">
    <link rel="stylesheet" href="designs/mobile-shell.css">
    
    <style>
        
    :root {
    --bg-main: #F5F5F7;
    --bg-stage: #0e9c34ab;
    --text-main: #000000;
    --glass-bg: rgba(0, 0, 0, 0.05);
    --glass-border: rgba(0, 0, 0, 0.1);
    --glass-tint-rgb: 255, 255, 255; /* Fixed: Removed text and added semicolon */
    --brand-orange: #FF8C00;
    --brand-gloss: linear-gradient(135deg, #FFB347 0%, #FF8C00 100%);
    --brand-shadow: 0 4px 15px rgba(255, 140, 0, 0.3), inset 0 2px 5px rgba(255, 255, 255, 0.4);
}

@media (prefers-color-scheme: dark) {
    :root {
        --bg-main: #000000;
        --bg-stage: #e4840e;
        --text-main: #FFFFFF;
        --glass-bg: rgba(255, 255, 255, 0.05);
        --glass-border: rgba(255, 255, 255, 0.1);
        --glass-tint-rgb: 0, 0, 0; /* Fixed: Removed text and added semicolon */
    }
}

    /* Core Layout Unlock */
    #appShell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overflow-y: visible;
    }

    /* Chameleon Search Styles */
    .search-bar {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        padding: 15px 25px;
        border-radius: 50px;
        display: flex;
        align-items: center;
        transition: all 0.6s cubic-bezier(0.2, 1, 0.3, 1);
        width: 100%;
        height: 54px;
        box-sizing: border-box;
    }

    .search-bar.collapsed {
        cursor: pointer;
        width: 50px; height: 50px; padding: 0;
        justify-content: center; margin-left: auto;
        background: var(--brand-gloss);
        box-shadow: var(--brand-shadow);
        border-radius: 50%;
        border-color: transparent;
    }

    .search-bar input {
        background: none; border: none; color: var(--text-main);
        margin-left: 10px; width: 100%; outline: none;
    }

    .search-bar.collapsed input, .search-bar.collapsed .mag-icon { display: none !important; }
    .collapse-icon { width: 22px !important; display: none; filter: brightness(0) invert(1); }
    .search-bar.collapsed .collapse-icon { display: block !important; }
    
    </style>
</head>
<body style="background: var(--bg-stage); color: var(--text-main); margin: 0; font-family: sans-serif;">

<aside class="sidebar">
    <div class="sidebar-content" style="display: flex; flex-direction: column; height: 100%; padding: 0;">
        
        <div style="margin-bottom: 50px; display: flex; justify-content: space-between; align-items: flex-start;">
            <button onclick="toggleMenu(event)" style="background: rgba(var(--glass-tint-rgb), 0.2); border: 1px solid rgba(255,255,255,0.1); color: var(--text-main); font-size: 18px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">‚úï</button>
            <button id="theme-toggle" onclick="toggleTheme()" style="background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 50%; width: 40px; height: 40px; color: var(--text-main); cursor: pointer; display: flex; align-items: center; justify-content: center;">üåì</button>
        </div>

        <div style="margin-bottom: 50px; padding: 0 10px;">
            <h2 style="margin: 0; font-size: 32px; font-weight: 700; line-height: 1.2; color: var(--text-main);">
                <span id="greetingTime" style="display: block; font-size: 14px; opacity: 0.5; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Good Morning,</span>
                <span id="userFirstName">User</span>
            </h2>
        </div>

        <div class="nav-links-list" style="flex-grow: 1; display: flex; flex-direction: column; gap: 12px;">
            <p style="font-size: 11px; opacity: 0.3; text-transform: uppercase; margin-bottom: 5px; margin-left: 10px;">Menu</p>
            <a href="#" class="side-link"><img src="assets/icons/profile.webp" width="20"> Profile</a>
            <a href="wallet.html" class="side-link"><img src="assets/icons/wallet.webp" width="20"> My Wallet</a>
            <a href="#" class="side-link"><img src="assets/icons/history.webp" width="20"> History</a>
            <a href="#" class="side-link"><img src="assets/icons/settings.webp" width="20"> Settings</a>
            <a href="#" class="side-link">
    <div id="userInitialCircle" style="width: 24px; height: 24px; border-radius: 50%; background: var(--brand-orange); color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; text-transform: uppercase;">
        U
    </div> 
    Profile
</a>
        </div>

        <div style="margin-top: auto; padding: 20px 0 40px 0; border-top: 1px solid rgba(255,255,255,0.1);">
            <a href="logout.html" class="side-link" style="color: #ff4444 !important; font-weight: 600; display: flex; align-items: center; gap: 15px; text-decoration: none;">
                <img src="assets/icons/logout.webp" width="20" style="filter: invert(27%) sepia(91%) saturate(2352%) hue-rotate(346deg) brightness(104%) contrast(105%);"> 
                Sign Out
            </a>
        </div>
    </div>
</aside>

<main id="appShell">
    <div id="home-view">
        <div id="dynamic-hero-header" style="height: 38vh; position: relative; background: url('assets/landmarks/default.webp') center/cover; border-radius: 0 0 40px 40px; overflow: hidden;">
            <header class="app-header" style="padding: 20px; display: flex; justify-content: space-between; align-items: flex-start;">
                <button class="menu-trigger" onclick="toggleMenu(event)" style="background:none; border:none; color:white; font-size:24px;">‚ò∞</button>
                <div class="action-stack" style="display: flex; flex-direction: column; align-items: flex-end; gap: 15px; width: 65%;">
                    <div class="notification-container" onclick="ActivityCenter.openPanel()" style="cursor: pointer;">
                        <img src="assets/icons/notification.webp" style="width: 24px; opacity: 0.8;">
                    </div>
                    <div class="search-bar" id="mainSearchBar">
                        <span class="mag-icon">üîç</span>
                        <input type="text" id="landmarkSearch" placeholder="Search #Landmarks">
                        <img src="assets/icons/explore.webp" class="collapse-icon">
                    </div>
                </div>
            </header>

            <div class="hero-balance-area" style="position:absolute; bottom: 5px; right: 25px; text-align: right; z-index: 100;">
    <p style="font-size: 11px; text-transform: uppercase; opacity: 0.6; margin-bottom: 5px;">Available balance</p>
    <div style="display: flex; align-items: center; gap: 12px; padding: 8px 0; justify-content: flex-end;">
        <h1 id="walletDisplay" style="font-size: 26px; margin: 0; color: white; min-height: 32px;"></h1>
        <button onclick="toggleBalance()" style="background: none; border: none; color: white; cursor: pointer; font-size: 30px; opacity: 0.8;">üëÅ</button>
    </div>
</div>
        </div>

        <div class="system-base-container" style="padding: 40px 0 120px 0; background: var(--bg-main); margin-top: -30px; border-radius: 30px 30px 0 0;">
            <div class="pillar-scroll" id="homePillars"></div>

            <div id="grouped-discover-feed" style="padding: 20px;">
                <div class="feed-group">
                    <h3 style="font-size: 14px; opacity: 0.5; text-transform: uppercase; margin-bottom: 20px;">Local Landmarks</h3>
                    <div id="landmark-feed-items"></div>
                </div>
                
                <div class="feed-group" style="margin-top: 40px;">
                    <h3 style="font-size: 14px; opacity: 0.5; text-transform: uppercase;">Credit Builder Status</h3>
                    <div style="background: var(--glass-bg); padding: 25px; border-radius: 20px; border: 1px solid var(--glass-border); margin-top: 15px;">
                        <p style="font-size: 12px; opacity: 0.6;">Activity Level</p>
                        <h2 id="creditLevelLabel" style="margin: 5px 0;">--</h2>
                        <div style="height: 4px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 15px;">
                            <div id="credit-mini-progress" style="width: 0%; height: 100%; background: var(--brand-orange); border-radius: 10px; transition: width 1s;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="explore-view" style="display: none; padding: 40px 20px 120px 20px; min-height: 100vh;">
        <h2 style="color: var(--text-main); margin-top: 40px;">Explore Abuja</h2>
        <div id="explore-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;"></div>
    </div>
</main>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="goHome()">
        <img src="assets/icons/home.webp" width="24"><span>Home</span>
    </div>
    <div class="nav-item" onclick="triggerExplore()">
        <img src="assets/icons/explore.webp" width="24"><span>Explore</span>
    </div>
    <div class="nav-item"><img src="assets/icons/HUB.webp" width="24"><span>Hub</span></div>
    <div class="nav-item"><img src="assets/icons/messages.webp" width="24"><span>Messages</span></div>
</nav>

<div id="panel-overlay" onclick="ActivityCenter.closePanel()"></div>
<div id="right-panel" style="background: var(--bg-main);">
    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 25px; padding: 20px;">
        <span onclick="ActivityCenter.closePanel()" style="cursor: pointer; font-size: 28px; color: var(--brand-orange);">‚Üê</span>
        <h2 style="margin: 0;">Activity</h2>
    </div>
    <div id="activity-feed" style="padding: 0 20px;"></div>
</div>

<script src="themeservice.js"></script>
<script src="services/databaseService.js"></script>
<script src="services/landmarkService.js"></script>
<script src="services/creditEngine/app.js"></script>

<script>
    // 1. Data Sync (The "Fill in info" part)
    async function syncUI() {
        const hour = new Date().getHours();
        const greeting = hour < 12 ? "Good Morning," : hour < 18 ? "Good Afternoon," : "Good Evening,";
        document.getElementById('greetingTime').innerText = greeting;

        if (typeof databaseService !== 'undefined') {
            const data = await databaseService.getUserData();
            
            // Name & Initial
            const firstName = data.profile.name.split(' ')[0];
            document.getElementById('userFirstName').innerText = firstName;
            if (document.getElementById('userInitialCircle')) {
                document.getElementById('userInitialCircle').innerText = firstName.charAt(0);
            }

            /// Wallet & Credit - Store the balance in the attribute first
// Wallet & Credit - Total Disappear Start
const walletDisplay = document.getElementById('walletDisplay');
if (walletDisplay && data.wallet) {
    walletDisplay.setAttribute('data-balance', data.wallet.balance);
    walletDisplay.innerText = ""; // Totally empty
    walletDisplay.setAttribute('data-hidden', 'true');
}

// Credit status still shows as normal
document.getElementById('creditLevelLabel').innerText = data.credit.level;
document.getElementById('credit-mini-progress').style.width = data.credit.progress + '%';

            // Landmark Feed
            const feed = document.getElementById('landmark-feed-items');
            if (feed && data.landmarks) {
                feed.innerHTML = data.landmarks.map(place => `
                    <div style="background: var(--glass-bg); padding: 20px; border-radius: 20px; border: 1px solid var(--glass-border); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0; font-size: 16px; color: var(--text-main);">${place.name}</h4>
                            <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.6; color: var(--text-main);">${place.category}</p>
                        </div>
                        <span style="font-size: 10px; background: rgba(0,255,0,0.1); color: #00FF00; padding: 4px 8px; border-radius: 5px; font-weight: bold;">${place.status}</span>
                    </div>
                `).join('');
            }
        }
    }

    // 2. Navigation Functions

    function toggleBalance() {
    const display = document.getElementById('walletDisplay');
    const isHidden = display.getAttribute('data-hidden') === 'true';
    const realBalance = display.getAttribute('data-balance');
    
    if (isHidden) {

        // REVEAL: Type backwards
        display.setAttribute('data-hidden', 'false');
        const formatted = parseFloat(realBalance).toLocaleString();
        const fullText = `‚Ç¶${formatted}`;
        const chars = fullText.split('');
        
        display.innerText = "";
        let i = chars.length - 1;
        
        const typer = setInterval(() => {
            if (i >= 0) {
                // Add the character to the START of the string to "type backwards"
                display.innerText = chars[i] + display.innerText;
                i--;
            } else {
                clearInterval(typer);
            }
        }, 50); // Speed of typing (50ms)
        
    } else {
        // DISAPPEAR: Clear immediately
        display.innerText = "";
        display.setAttribute('data-hidden', 'true');
    }
}
    function triggerExplore() {
        document.getElementById('home-view').style.display = 'none';
        document.getElementById('explore-view').style.display = 'block';
        updateNav(1);
    }

    function goHome() {
        document.getElementById('explore-view').style.display = 'none';
        document.getElementById('home-view').style.display = 'block';
        updateNav(0);
    }

    function updateNav(idx) {
        document.querySelectorAll('.nav-item').forEach((n, i) => n.classList.toggle('active', i === idx));
    }

    function toggleMenu(event) {
        if (event) event.stopPropagation();
        document.body.classList.toggle('menu-open');
    }

    // 3. Chameleon Search & Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
        syncUI();

        const searchBar = document.getElementById('mainSearchBar');
        window.addEventListener('scroll', () => {
            if (window.scrollY > 80) searchBar.classList.add('collapsed');
        });

        searchBar.addEventListener('click', function() {
            if (this.classList.contains('collapsed')) {
                this.classList.remove('collapsed');
                document.getElementById('landmarkSearch').focus();
            }
        });
    });
</script>
</body>
</html>